<!DOCTYPE html>
<html>
<head lang="en">
<title>Comics</title>
<meta charset="UTF-8">

<style>
    /* img {
        width: auto !important;
        height: 1000px;
    } */

    #hiddenPage {
        display: none;
    }

</style>
    <script type="text/javascript" src="/eel.js"></script>
    <script>
        window.addEventListener('resize', function(event){
            document.getElementById('page').style.height = (window.innerHeight - 45) + 'px';
        });
    </script>
</head>
<body onkeydown="inputKey()">
<div>
    <input type='text' name="searchTitle" onkeydown="searchComics()">
    <select id='comics' onchange="onChangeComic()"></select>
    <select id='chapters' onchange="onChangeChapter()"></select>
    <input type="checkbox" onclick="onAutoCheck(this)">자동넘김
    <input id='autoPeriod' value="5" size="2">초
    <input id='curPage' size="3" onchange="onChangePage()"> / <span id='totalPage'></span>
</div>
<img id="page" onclick="next()"/>
<img id='hiddenPage'>

<script>
var pages = null;
var i = 0;
var autoTime;

var view_snapshot;

var selectedComic
var selectedChapter

var curPage = document.getElementById('curPage')
var totalPage = document.getElementById('totalPage')

function searchComics(e) {
    e = e || window.event;

    if (e.keyCode === 13) {
        eel.search(e.target.value)(refreshComics)
    }   
}

function onChangePage(e) {
    viewPage()
}

function onAutoCheck(cb) {
    var autoPeriod = parseInt(document.getElementById('autoPeriod').value)
    if (cb.checked) {
        autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod * 1000)
    } else {
        if (autoTime) {
            clearTimeout(autoTime)
        }
    }
}

function autoNext() {
    var autoPeriod = parseInt(document.getElementById('autoPeriod').value)
    next()
    autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod * 1000)
}

function inputKey(e) {
    e = e || window.event;

    const prevKeys = [37, 38, 33]
    const nextKeys = [32, 39, 40, 34]

    if (prevKeys.indexOf(e.keyCode) >= 0) {
        prev()
    } else if (nextKeys.indexOf(e.keyCode) >= 0) {
        next()
    }
}

function getViewSnapshot() {
    eel.snapshot()(refreshComics)
}

function make_option(value, text) {
    var opt = document.createElement('option');
    opt.value = value;
    opt.innerHTML = text;
    return opt
}

function refreshComics(response) {
    view_snapshot = response
    var comics = document.getElementById('comics')
    comics.options.length = 0;
    comics.appendChild(make_option('', ''));
    for (var key in view_snapshot) {
        comics.appendChild(make_option(key, view_snapshot[key]['title']));
    }
    chapters.options.length = 0
    selectedComic = null
    selectedChapter = null
    curPage.value = ''
    totalPage.innerText = ''
}

function onChangeComic() {
    var comics = document.getElementById('comics')
    if (comics.selectedIndex > 0) {
        selectedComic = comics.options[comics.selectedIndex].value
        getChapters(comics.options[comics.selectedIndex].value)
    }
}

function onChangeChapter() {
    var chapters = document.getElementById('chapters')
    selectedChapter = chapters.options[chapters.selectedIndex].value
    getPages(chapters.options[chapters.selectedIndex].value)
}

function getChapters(url) {
    eel.chapters(url)(refreshChapters)
}

function refreshChapters(response) {
    var chapters = document.getElementById('chapters')
    chapters.options.length = 0
    for (var i = 0; i < response.length; i++){
        chapters.appendChild(make_option(response[i]['url'], response[i]['title']));
    }
    
    if (view_snapshot && view_snapshot[selectedComic] && view_snapshot[selectedComic]['chapter']) {
        selectedChapter = view_snapshot[selectedComic]['chapter']
        chapters.value = selectedChapter
    } else {
        selectedChapter = chapters.value
    }

    getPages(selectedChapter)
}

function getPages(url) {
    eel.pages(url)(refreshPages)
}

function viewStartPage() {
    var curPage = document.getElementById('curPage')
    if (view_snapshot && view_snapshot[selectedComic] && view_snapshot[selectedComic]['page']) {
        curPage.value = view_snapshot[selectedComic]['page']
    } else {
        curPage.value = 1
    }
    totalPage.innerText = pages.length
    viewPage()
}

function refreshPages(response) {
    pages = response;
    viewStartPage();
}

function viewPage() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)
    var page = document.getElementById('page')
    var hiddenPage = document.getElementById('hiddenPage')
    page.src = pages[i-1]
    if (i < pages.length-1) {
        hiddenPage.src = pages[i]
    }

    callViewLog()
}

function callViewLog() {
    var comics = document.getElementById('comics')
    var chapters = document.getElementById('chapters')
    var curPage = document.getElementById('curPage')
    var viewComic = comics.options[comics.selectedIndex]
    var viewChapter = chapters.options[chapters.selectedIndex]
    eel.view(viewComic.value, viewComic.text, viewChapter.value, curPage.value)
}

function next() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)

    if (pages && i < pages.length) {
        curPage.value = i+1
    } else {
        var chapters = document.getElementById('chapters')
        if (chapters.selectedIndex < chapters.options.length - 1) {
            chapters.selectedIndex++
            onChangeChapter()
        } else {
            alert('마지막입니다.')
        }
    }
    viewPage();
}

function prev() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)
    if (pages && i > 1) {
        curPage.value = i-1
    } else {
        alert('처음입니다.')
    }
    viewPage()
}


getViewSnapshot()


</script>
</body>
</html>