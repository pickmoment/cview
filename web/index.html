<!DOCTYPE html>
<html>
<head lang="en">
<title>Comics</title>
<meta charset="UTF-8">

<style>
    /* img {
        width: auto !important;
        height: 1000px;
    } */

    #hiddenPage {
        display: none;
    }

</style>
    <script type="text/javascript" src="/eel.js"></script>
    <script>
        window.addEventListener('resize', function(event){
            document.getElementById('page').style.height = (window.innerHeight - 40) + 'px';
        });
    </script>
</head>
<body onkeydown="inputKey()">
<div>
    <input type='text' name="searchTitle" onkeydown="searchComics()">
    <select id='comics' onchange="changeComic()"></select>
    <select id='chapters' onchange="changeChapter()"></select>
    <input type="checkbox" onclick="autoCheck(this)">
    <input id='autoPeriod' value="3000">
    <span id='curPage'></span> / <span id='totalPage'></span>
</div>
<img id="page" onclick="next()"/>
<img id='hiddenPage'>

<script>
var pages = null;
var i = 0;
var autoTime;

function searchComics(e) {
    e = e || window.event;
    console.log(e)
    if (e.keyCode === 13) {
        eel.search(e.target.value)(showComics)
    }   
}

function autoCheck(cb) {
    var autoPeriod = document.getElementById('autoPeriod').value
    if (cb.checked) {
        autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod)
    } else {
        if (autoTime) {
            clearTimeout(autoTime)
        }
    }
}

function autoNext() {
    var autoPeriod = document.getElementById('autoPeriod').value
    next()
    autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod)
}

function inputKey(e) {
    e = e || window.event;

    const prevKeys = [37, 38]
    const nextKeys = [32, 39, 40]

    if (prevKeys.indexOf(e.keyCode) >= 0) {
        prev()
    } else if (nextKeys.indexOf(e.keyCode) >= 0) {
        next()
    }
}

function getComics() {
    eel.comics()(showComics)
}

function showComics(response) {
    var comics = document.getElementById('comics')
    comics.options.length = 0;
    for (var i = 0; i < response.length; i++){
        var opt = document.createElement('option');
        opt.value = response[i]['url'];
        opt.innerHTML = response[i]['title'];
        comics.appendChild(opt);
    }    
    getChapters(response[0]['url'])
}

function changeComic() {
    var comics = document.getElementById('comics')
    getChapters(comics.options[comics.selectedIndex].value)
}

function changeChapter() {
    i = 0
    var chapters = document.getElementById('chapters')
    getPages(chapters.options[chapters.selectedIndex].value)
}

function getChapters(url) {
    eel.chapters(url)(showChapters)
}

function showChapters(response) {
    var chapters = document.getElementById('chapters')
    while (chapters.options.length > 0) {                
        chapters.remove(0);
    }   
    for (var i = 0; i < response.length; i++){
        var opt = document.createElement('option');
        opt.value = response[i]['url'];
        opt.innerHTML = response[i]['title'];
        chapters.appendChild(opt);
    }
    getPages(response[0]['url'])
}

function getPages(url) {
    eel.pages(url)(showResponse)
}

function viewFirstPage() {
    i = 0;
    var page = document.getElementById('page')
    var hiddenPage = document.getElementById('hiddenPage')
    page.src = pages[i]
    hiddenPage.src = pages[i+1]
    document.getElementById('totalPage').innerText = pages.length
    document.getElementById('curPage').innerText = i+1
}

function showResponse(response) {
    pages = response;
    viewFirstPage();
}

function next() {
    var page = document.getElementById('page')
    var hiddenPage = document.getElementById('hiddenPage')

    if (pages && i < pages.length-1) {
        page.src = pages[++i];
        if (i < pages.length-2) {
            hiddenPage.src = pages[i+1]
        }
    } else {
        var chapters = document.getElementById('chapters')
        if (chapters.selectedIndex < chapters.options.length - 1) {
            chapters.selectedIndex++
            changeChapter()
        } else {
            alert('마지막 페이지입니다.')
        }
    }
    document.getElementById('curPage').innerText = i+1
}

function prev() {
    if (pages && i > 0) {
        page.src = pages[--i];
    } else {
        alert('첫 페이지입니다.')
    }
    document.getElementById('curPage').innerText = i+1
}


getComics()


</script>
</body>
</html>