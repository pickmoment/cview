<!DOCTYPE html>
<html>
<head lang="en">
<title>Comics</title>
<meta charset="UTF-8">

<style>
    /* img {
        width: auto !important;
        height: 1000px;
    } */

    #hiddenPage {
        display: none;
    }

</style>
    <script type="text/javascript" src="/eel.js"></script>
    <script>
        window.addEventListener('resize', function(event){
            document.getElementById('page').style.height = (window.innerHeight - 40) + 'px';
        });
    </script>
</head>
<body onkeydown="inputKey()">
<div>
    <input type='text' name="searchTitle" onkeydown="searchComics()">
    <select id='comics' onchange="changeComic()"></select>
    <select id='chapters' onchange="changeChapter()"></select>
    <input type="checkbox" onclick="autoCheck(this)">자동넘김
    <input id='autoPeriod' value="5" size="2">초
    <input id='curPage' size="3" onchange="onChangePage()"> / <span id='totalPage'></span>
</div>
<img id="page" onclick="next()"/>
<img id='hiddenPage'>

<script>
var pages = null;
var i = 0;
var autoTime;

function searchComics(e) {
    e = e || window.event;

    if (e.keyCode === 13) {
        eel.search(e.target.value)(showComics)
    }   
}

function onChangePage(e) {
    viewPage()
}

function autoCheck(cb) {
    var autoPeriod = parseInt(document.getElementById('autoPeriod').value)
    if (cb.checked) {
        autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod * 1000)
    } else {
        if (autoTime) {
            clearTimeout(autoTime)
        }
    }
}

function autoNext() {
    var autoPeriod = parseInt(document.getElementById('autoPeriod').value)
    next()
    autoTime = setTimeout(function() {
            autoNext();
        }, autoPeriod * 1000)
}

function inputKey(e) {
    e = e || window.event;

    const prevKeys = [37, 38, 33]
    const nextKeys = [32, 39, 40, 34]

    if (prevKeys.indexOf(e.keyCode) >= 0) {
        prev()
    } else if (nextKeys.indexOf(e.keyCode) >= 0) {
        next()
    }
}

function getComics() {
    eel.comics()(showComics)
}

function showComics(response) {
    var comics = document.getElementById('comics')
    comics.options.length = 0;
    for (var i = 0; i < response.length; i++){
        var opt = document.createElement('option');
        opt.value = response[i]['url'];
        opt.innerHTML = response[i]['title'];
        comics.appendChild(opt);
    }    
    getChapters(response[0]['url'])
}

function changeComic() {
    var comics = document.getElementById('comics')
    getChapters(comics.options[comics.selectedIndex].value)
}

function changeChapter() {
    var chapters = document.getElementById('chapters')
    getPages(chapters.options[chapters.selectedIndex].value)
}

function getChapters(url) {
    eel.chapters(url)(showChapters)
}

function showChapters(response) {
    var chapters = document.getElementById('chapters')
    while (chapters.options.length > 0) {                
        chapters.remove(0);
    }   
    for (var i = 0; i < response.length; i++){
        var opt = document.createElement('option');
        opt.value = response[i]['url'];
        opt.innerHTML = response[i]['title'];
        chapters.appendChild(opt);
    }
    getPages(response[0]['url'])
}

function getPages(url) {
    eel.pages(url)(showResponse)
}

function viewFirstPage() {
    var curPage = document.getElementById('curPage')
    curPage.value = 1
    document.getElementById('totalPage').innerText = pages.length
    viewPage()
}

function showResponse(response) {
    pages = response;
    viewFirstPage();
}

function viewPage() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)
    var page = document.getElementById('page')
    var hiddenPage = document.getElementById('hiddenPage')
    page.src = pages[i-1]
    if (i < pages.length-1) {
        hiddenPage.src = pages[i]
    }
}

function next() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)

    if (pages && i < pages.length) {
        curPage.value = i+1
    } else {
        var chapters = document.getElementById('chapters')
        if (chapters.selectedIndex < chapters.options.length - 1) {
            chapters.selectedIndex++
            changeChapter()
        } else {
            alert('마지막입니다.')
        }
    }
    viewPage();
}

function prev() {
    var curPage = document.getElementById('curPage')
    var i = parseInt(curPage.value)
    if (pages && i > 1) {
        curPage.value = i-1
    } else {
        alert('처음입니다.')
    }
    viewPage()
}


getComics()


</script>
</body>
</html>